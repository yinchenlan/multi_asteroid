<html>
<head>
    <meta charset="utf-8">
    <!--<meta name="viewport" content="width=device-width, user-scalable=no">-->
    <title>Space Shooter Game</title>
    <style>
      html, body {
      width: 100%;
      height: 100%;
      margin: 0px;
      border: 0;
      overflow: hidden; /*  Disable scrollbars */
      display: block;  /* No floating content on sides */
      }
    </style>
</head>
<script src="/socket.io/socket.io.js"></script>

<body style="background-color:lightgrey;" onload="showBOTPlaying(); return false;">
    <table>
        <tr>
            <td>
                <canvas id="gameCanvas"></canvas>
                <form name = "nameForm" action="#"> 
                <font color="blue">Enter Name: </font><input type="text" name="nickName" value="Ace">
                <input type="submit" value="Start" onclick="socket = connect(); createPlayerSession(); updateSocket(); setNickName(); hideForm(); return false;">
                </form> 
            </td>
        </tr>
    </table>
    <script>
        /**
         * An Asteroid-like game.
         * Author: Chuck Lan
         **/
        function serverLog(msg) {
            socket.emit("serverLog", {
                "log": msg
            });
        }

        function showBOTPlaying() {
            socket = connect(); 
            createBOTSession(); 
            updateSocket(); 
        }

        function initialize() {
            // Register an event listener to
            // call the resizeCanvas() function each time 
            // the window is resized.
            window.addEventListener('resize', resizeCanvas, false);
        
            // Draw canvas border for the first time.
            resizeCanvas();
                //alert("resized");
	    }

        function resizeCanvas() {
            canvas.width = window.innerWidth - 10;
            canvas.height = window.innerHeight - 30;
                updateScale();
                if (socket != null)
                    socket.emit("wr", {"sId": sessionId, "s": scale, "w": canvas.width, "h": canvas.height});
        }
        
        function setNickName() {
            nickName = document.nameForm.nickName.value;
        }

        function hideForm() {
            document.nameForm.style.display="none";
        }
        
        function unhideForm() {
            document.nameForm.style.display="block";
        }

        function getXOffset() {
            if (sessionId != null && PlayerSession.all[sessionId] != null) {
                var negX = -1 * PlayerSession.all[sessionId].turret.x;
                var offset = negX + canvas.width/2/scale;
	        if (PlayerSession.all[sessionId].turret.x < canvas.width/2/scale) {
	            return 0;
                } else if (PlayerSession.all[sessionId].turret.x > MAX_X - canvas.width/2/scale) {
	            return -(MAX_X - canvas.width/scale);
	        }
                return offset; 
            }
            return 0;
        }

        function getYOffset() {
            if (sessionId != null && PlayerSession.all[sessionId] !=null) {
                var negY = -1 * PlayerSession.all[sessionId].turret.y;
                var offset = negY + gameCanvas.height/2/scale;
                if (PlayerSession.all[sessionId].turret.y < canvas.height/2/scale) {
		    return 0;       
                } else if (PlayerSession.all[sessionId].turret.y > MAX_Y - canvas.height/2/scale) {
	            return -(MAX_Y - canvas.height/scale);
                }
                return offset;
            }
            return 0;
        }

        function getMousePos(canvas, evt) {
            // get canvas position
            var obj = canvas;
            var top = 0;
            var left = 0;
            while (obj && obj.tagName != 'BODY') {
                top += obj.offsetTop;
                left += obj.offsetLeft;
                obj = obj.offsetParent;
            }
            // return relative mouse position
            var ps = PlayerSession.all[sessionId];
            if (ps != null) {
                var turret = ps.turret;
                turret.mousePosX = (-getXOffset() + evt.clientX / scale - left + window.pageXOffset);
                turret.mousePosY = (-getYOffset() + evt.clientY / scale - top + window.pageYOffset);
                socket.emit("mp", {
                    "mousePosX": turret.mousePosX,
                    "mousePosY": turret.mousePosY
                });
            }
        }
        var hor = 0,
            ver = 0,
            score = 0,
            gameOver = 0,
            gamePaused = 0,
            started = 0,
            mouseDown = 0,
            endscoresend = 0;
        var rockDate = new Date();
        var mouseDate = new Date();
        var scores = [];
        //var unsortedScores = [];
        var socket = null;
        var sessionId = null;
        var transparency = 0.6;
        var starsPositions = [];
        var nickName = "";
        var deleteRockSet = {};
        var deleteBulletSet = {};
        var deletePlayerSessionSet = {};
        var MAX_X = 3200;
        var MAX_Y = 2400;
        var WINDOW_X_SIZE = 800;
        var WINDOW_Y_SIZE = 600;
        var starsCanvas = null;
        var starsCtx = null;
        var scale = 1;
        var activePowerUp = null; // current active power-up: "rockets", "lasers", "spreadShot", "rapidFire", or null
        var deletePowerUpSet = {};
        var PowerUp = {
            all: {}
        };

        function updateScale() {
            var scaleX = canvas.width / WINDOW_X_SIZE;
            var scaleY = canvas.height / WINDOW_Y_SIZE;
            scale = Math.max(1, Math.max(scaleX, scaleY));
            ctx.scale(scale, scale);
        }

        function strcmp(a, b) {
            if (a.toString() < b.toString()) return -1;
            if (a.toString() > b.toString()) return 1;
            return 0;
        }

	function sortScores() {
            var rv = scores.splice(0);
            if (rv != null) {
                rv.sort(function(a, b) {
                    var diff = b["s"] - a["s"];
                    //if (diff > 0) alert("diff " + diff);
	            if (diff == 0) diff = strcmp(b["n"], a["n"]);
                    //if (diff != 0) alert("diff " + diff);
                    return diff;
	        });
            }
            return rv;
        }

        function connect() {
            gameOver = 0;
            return io.connect(location.hostname + ':' + location.port, 
            {transports: ['websocket']});
        }

        function createPlayerSession() {
            socket.emit("cps");
        }

        function createBOTSession() {
            socket.emit("cbs");
        }

        function updateSocket() {
            socket.on("connected", function(data) {
                var turret = new Turret(data["x"], data["y"], data["color"]);
                turret.life = data["life"];
                sessionId = data["sessionId"];
                var ps = new PlayerSession(sessionId, turret, data["timeLeft"]);
                setNickNameToPlayerSession();
                socket.emit("wr", {"sId": sessionId, "s": scale, "w": canvas.width, "h": canvas.height});
            });

            socket.on("rp", function(data) {
                //alert("deleting " + data["sId"]);
                //delete PlayerSession.all[data["sId"]];
                deletePlayerSessionSet[data["sId"]] = 1;
            });

            socket.on("gb", function(data) {
                var bullet = Bullet.deserialize(data);
            });

            socket.on("lb", function(data) {
                if (data["ss"] != null) { 
                    scores = data["ss"];
                    scores = sortScores();      
                    //alert("lb " + scores.length);
                }
            });

            socket.on("stars", function(data) {
                starsPositions = data["stars"];
                starsCanvas = document.createElement("canvas");
                starsCanvas.width = MAX_X;
                starsCanvas.height = MAX_Y;
                starsCtx = starsCanvas.getContext("2d");
                starsCtx.save();
                starsCtx.fillStyle = "black";
                starsCtx.fillRect(0, 0, starsCanvas.width, starsCanvas.height);
                starsCtx.restore();
                const colors = ["yellow", "white", "grey", "orange", "blue", "red"];
                for (var i in starsPositions) {
                    //alert("i " + i);
                    var pos = starsPositions[i];
                    var x = pos[0];
                    var y = pos[1];
                    //alert("x " + x + ", y " + y);
                    starsCtx.save();
                    starsCtx.translate(x, y);
                    const currColor = colors[Math.floor(Math.random() * colors.length)];
                    starsCtx.fillStyle = currColor;
                    starsCtx.strokeStyle = currColor;
                    starsCtx.beginPath();
                    starsCtx.arc(0, 0, 1, 0, Math.PI * 2, true);
                    starsCtx.closePath();
                    starsCtx.fill();
                    starsCtx.stroke();
                    starsCtx.restore();
                }

            });

            socket.on("cr", function(data) {
                var rock = Rock.deserialize(data);
                Rock.all[rock.id] = rock;
            });

            socket.on("readscore", function(data) {
                //debug("scores " + scores);
                if (data > 0) {
                    scores.push(data);
                }
            });

            socket.on("endscoresend", function() {
                endscoresend = 1;
            });

            socket.on("uw", function(data) {
                //debug("updateWorld");
                var me = PlayerSession.all[sessionId];
                PlayerSession.all = {};
                PlayerSession.all[sessionId] = me;
                executeCommands(data["updateWorld"]);
                //drawWorld();
            });

            socket.on("powerUp", function(data) {
                // Update player's active power-up
                var oldPowerUp = activePowerUp;
                activePowerUp = data["activePowerUp"];
                
                if (oldPowerUp !== activePowerUp) {
                    console.log("Power-up changed from " + (oldPowerUp || "normal") + " to " + (activePowerUp || "normal"));
                } else {
                    console.log("Power-up state sync: " + (activePowerUp || "normal"));
                }
            });
        }

        function removePlayer(data) {
            var ps = PlayerSession.all[data];
            if (ps != null) {
                ps.remove();
                delete deletePlayerSessionSet[data];
                if (data == sessionId) {
                    console.log("Player died/removed - preserving power-up state: " + (activePowerUp || "normal"));
                    // DON'T reset activePowerUp here - let server manage it
                    socket.disconnect();
                    gameOver = 1;
                    Rock.all = {};
                    Bullet.all = {};
                    PlayerSession.all = {};
                    deletePlayerSessionSet = {};
                    deleteRockSet = {};
                    deleteBulletSet = {};
                    nickName = "";
                    showBOTPlaying();
                    unhideForm();
                }
            }
        };

        function damagePlayer(data) {
            //debug("damagePlayer");
            var ps = PlayerSession.all[data["sessionId"]];
            if (ps != null)
                ps.turret.life = data["life"];
        };


        function createRock(data) {
            //debug("createRock");
            var rock = Rock.deserialize(data);
            Rock.all[rock.id] = rock;
        };

        function resizeRock(data) {
            //debug("resizeRock");
            var rock = Rock.deserialize(data);
            Rock.all[rock.id] = rock;
        };

        function createBullet(data) {
            //debug("createBullet");
            var bullet = new Bullet(data["x"], data["y"], data["r"], data["color"], data["sessionId"], data["id"]);
            bullet.vx = data["vx"];
            bullet.vy = data["vy"];
            bullet.type = data["type"] || "normal";
        };

        function removeBullet(data) {
            //alert("removeBullet " + data["id"]);
            if (Bullet.all[data] != null) {
                //alert("remove bullet "  + data);
                delete Bullet.all[data];
                delete deleteBulletSet[data];
            }
        };

        function removeRock(data) {
            //alert("removeRock " + data["id"]);
            if(Rock.all[data] != null) {
                delete Rock.all[data];
                delete deleteRockSet[data];
            }
        };

        function createPowerUp(data) {
            var powerUp = {
                id: data.id,
                x: data.x,
                y: data.y,
                type: data.type,
                size: data.size,
                bobOffset: data.bobOffset,
                vx: data.vx || 0,
                vy: data.vy || 0,
                rotation: data.rotation || 0,
                rotationSpeed: data.rotationSpeed || 0
            };
            PowerUp.all[data.id] = powerUp;
        };

        function removePowerUp(data) {
            if (PowerUp.all[data] != null) {
                delete PowerUp.all[data];
                delete deletePowerUpSet[data];
            }
        };

        function updatePowerUp(data) {
            var powerUp = PowerUp.all[data.id];
            if (powerUp != null) {
                powerUp.x = data.x;
                powerUp.y = data.y;
                if (data.rotation !== undefined) powerUp.rotation = data.rotation;
            }
        };


        function turretMove(data) {
                var turretMove = data;
                var sessId = turretMove["sId"];
                var x = turretMove["x"];
                var y = turretMove["y"];
                var color = turretMove["c"];
                var recoil = turretMove["r"];
                var recoilX = turretMove["rx"];
                var recoilY = turretMove["ry"];
                var mousePosX = turretMove["mpx"];
                var mousePosY = turretMove["mpy"];
                var angle = turretMove["a"];
                var name = turretMove["n"];
                var ps = PlayerSession.all[sessId];
                if (ps == null) {
                    var turret = new Turret(x, y, color);
                    //alert("creating new player session " + sessId);
                    ps = new PlayerSession(sessId, turret, turretMove["tl"]);
                }
                ps.name = name;
                ps.kills = turretMove["k"];
                var turret = ps.turret;
                turret.x = x;
                turret.y = y;
                turret.color = color;
                turret.mousePosX = mousePosX;
                turret.mousePosY = mousePosY;
                turret.angle = angle;
                turret.recoil = recoil;
                turret.recoilX = recoilX;
                turret.recoilY = recoilY;
                turret.life = turretMove["l"];
        };

        function executeCommands(commands) {
            //debug("command length : " + commands.length);
            for (var idx in commands) {
                var cmd = commands[idx];
                //if (cmd[0] == "removePlayer") alert ("hi ");
                executeCommand(commands[idx]);
            }
        }

        function removeStuff() {
            for (var key in deleteBulletSet) {
                removeBullet(key);
                //delete deleteBulletSet[key];
            }
            for (var key in Bullet.all) {
                var bullet = Bullet.all[key];
                var x = bullet.x + getXOffset();
                var y = bullet.y + getYOffset();
                if (x < -100 || x > 900 || y < -100 || y > 700) 
                    bullet.remove();
            }
            
            for (var key in deletePlayerSessionSet) {
                //alert("remove player " + key);
                removePlayer(key);
                //delete deletePlayerSessionSet[key];
            }
            /*
            for (var key in PlayerSession.all) {
		var ps = PlayerSession.all[key];
		var x = ps.turret.x + getXOffset();
		var y = ps.turret.y + getYOffset();
		if (x < -100 || x> 900 ||y < -100 || y > 700)
                    ps.remove();
            }*/
            
            for (var key in deleteRockSet) {
                removeRock(key);
                //delete deleteRockSet[key];
            }

            for (var key in Rock.all) {
                var rock = Rock.all[key];
                var x = rock.x + getXOffset();
                var y = rock.y + getYOffset();
                if (x < -100 || x> 900 ||y < -100 || y > 700) 
                    rock.remove();
            }

            // Clean up power-ups marked for deletion
            for (var key in deletePowerUpSet) {
                removePowerUp(key);
            }
            
            // Remove power-ups that drifted off screen (they'll respawn from server)
            for (var key in PowerUp.all) {
                var powerUp = PowerUp.all[key];
                var x = powerUp.x + getXOffset();
                var y = powerUp.y + getYOffset();
                if (x < -200 || x > 1000 || y < -200 || y > 800) {
                    delete PowerUp.all[key]; // just remove locally, server will manage
                }
            }
        }

        function executeCommand(command) {
            //if (command[0] == "removePlayer") alert ("remove " + command[1]["sessionId"]);
            //debug("command : " + command[0]);
            switch (command[0]) {
                case "rp":
                    break;
                case "damagePlayer":
                    damagePlayer(command[1]);
                    break;
                case "cr":
                    createRock(command[1]);
                    break;
                case "rr":
                    resizeRock(command[1]);
                    break;
                case "cb":
                    createBullet(command[1]);
                    break;
                case "rb":
                    deleteBulletSet[command[1]["id"]] = 1;
                    break;
                case "rmr":
                    deleteRockSet[command[1]["id"]] = 1;
                    break;
                case "cpu":
                    createPowerUp(command[1]);
                    break;
                case "rpu":
                    deletePowerUpSet[command[1]["id"]] = 1;
                    break;
                case "tm":
                    turretMove(command[1]);
                    break;
                case "ur":
                    Rock.moveRock(command[1]);
                    break;
                case "ub":
                    Bullet.moveBullet(command[1]);
                    break;
                case "upu":
                    updatePowerUp(command[1]);
                    break;
            }
        }

        var canvas = document.getElementById("gameCanvas");
        canvas.style.backgroundColor = 'black';
        var ctx = canvas.getContext('2d');

        initialize();

        function resetGame() {
            var ps = PlayerSession.all[sessionId];
            ps.remove();
            socket.socket.reconnect();
        }

        function pauseGame() {
            if (gamePaused == 1) {
                gamePaused = 0;
            } else {
                gamePaused = 1;
            }
        }

        function isValidNameChar(ch) {
            return ch == 8 || ch == 13 || (ch >= 48 && ch <= 57) ||
                (ch >= 65 && ch <= 90) || (ch >= 97 && ch <= 122);
        }

        function setNickNameToPlayerSession() {
            if (nickName)
                PlayerSession.all[sessionId].name = nickName;
            socket.emit("nickName", {
                "sessionId": sessionId,
                "name": nickName
            });
            //alert("nickname sent " + nickName); 
        }

        window.addEventListener('keydown', function(event) {
            switch (event.keyCode) {
                case 82:
                    /* Restart */
                    resetGame();
                    break;
                case 83:
                    /* Start */
                    started = 1;
                    break;
                case 80:
                    /* Pause/Unpause */
                    if (started == 1)
                        pauseGame();
                    break;
            }
        }, true);
        // No keyup handlers needed for mouse-only movement
        // Pause/restart/start keys are handled in keydown only

        function drawTurrets() {
            for (var key in PlayerSession.all) {
                if (PlayerSession.all.hasOwnProperty(key)) {
                    var ps = PlayerSession.all[key];
                    var isYou = (ps.sessionId == sessionId);
                    var isGhost = ps.getTimeLeft() > 0;
                    drawTurret(ps, isYou, isGhost);
                }
            }
        }
        
        // Draw engine exhaust trails
        function drawEngineTrails(turret, isYou) {
            var speed = Math.sqrt((turret.x - (turret.lastX || turret.x)) ** 2 + (turret.y - (turret.lastY || turret.y)) ** 2);
            var thrustIntensity = Math.min(speed * 0.3, 1);
            
            if (thrustIntensity > 0.05) {
                var engineGradient = ctx.createLinearGradient(-8, 0, -12 - thrustIntensity * 8, 0);
                engineGradient.addColorStop(0, "rgba(100, 200, 255, 0.9)");
                engineGradient.addColorStop(0.3, "rgba(255, 150, 50, 0.8)");
                engineGradient.addColorStop(0.7, "rgba(255, 100, 0, 0.6)");
                engineGradient.addColorStop(1, "rgba(255, 255, 255, 0)");
                
                ctx.fillStyle = engineGradient;
                
                // Left engine trail
                ctx.beginPath();
                ctx.moveTo(-8, -2.5);
                ctx.lineTo(-12 - thrustIntensity * 8, -1.5);
                ctx.lineTo(-12 - thrustIntensity * 8, 1.5);
                ctx.lineTo(-8, 2.5);
                ctx.closePath();
                ctx.fill();
                
                // Right engine trail (correctly positioned)
                ctx.beginPath();
                ctx.moveTo(-8, 2.5);
                ctx.lineTo(-12 - thrustIntensity * 8, 1.5);
                ctx.lineTo(-12 - thrustIntensity * 8, -1.5);
                ctx.lineTo(-8, -2.5);
                ctx.closePath();
                ctx.fill();
            }
            
            // Store position for next frame
            turret.lastX = turret.x;
            turret.lastY = turret.y;
        }
        
        // Draw main ship hull
        function drawShipHull(turret, healthRatio, isYou) {
            var baseColor = turret.color;
            var size = turret.baseRadius;
            
            // Main hull gradient based on health
            var hullGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, size);
            hullGradient.addColorStop(0, lightenColor(baseColor, 40));
            hullGradient.addColorStop(0.6, baseColor);
            hullGradient.addColorStop(1, darkenColor(baseColor, 30));
            
            // Main ship body (elongated ellipse)
            ctx.fillStyle = hullGradient;
            ctx.strokeStyle = darkenColor(baseColor, 50);
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.ellipse(0, 0, size * 1.4, size * 0.8, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // Wing sections
            ctx.fillStyle = darkenColor(baseColor, 20);
            ctx.strokeStyle = darkenColor(baseColor, 40);
            ctx.lineWidth = 1;
            
            // Left wing
            ctx.beginPath();
            ctx.ellipse(-2, -size * 0.7, size * 0.6, size * 0.3, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // Right wing
            ctx.beginPath();
            ctx.ellipse(-2, size * 0.7, size * 0.6, size * 0.3, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // Engine nozzles
            ctx.fillStyle = "#444";
            ctx.strokeStyle = "#222";
            ctx.beginPath();
            ctx.ellipse(-8, -3, 3, 2, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            ctx.beginPath();
            ctx.ellipse(-8, 3, 3, 2, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
        }
        
        // Draw ship details and cockpit
        function drawShipDetails(turret, healthRatio, isYou, playerName) {
            var size = turret.baseRadius;
            
            // Cockpit/bridge
            var cockpitGradient = ctx.createRadialGradient(2, 0, 0, 2, 0, size * 0.5);
            cockpitGradient.addColorStop(0, "rgba(100, 200, 255, 0.8)");
            cockpitGradient.addColorStop(0.7, "rgba(50, 150, 255, 0.6)");
            cockpitGradient.addColorStop(1, "rgba(0, 100, 200, 0.4)");
            
            ctx.fillStyle = cockpitGradient;
            ctx.strokeStyle = "#1a4d80";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.ellipse(2, 0, size * 0.5, size * 0.3, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // Front nose/cannon mount
            ctx.fillStyle = "#666";
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(size * 1.4, 0);
            ctx.lineTo(size * 1.1, -3);
            ctx.lineTo(size * 0.8, -2);
            ctx.lineTo(size * 0.8, 2);
            ctx.lineTo(size * 1.1, 3);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Muzzle flash when firing
            if (turret.recoil > 0) {
                var flashGradient = ctx.createRadialGradient(size * 1.4, 0, 0, size * 1.4, 0, 8);
                flashGradient.addColorStop(0, "rgba(255, 255, 255, 0.9)");
                flashGradient.addColorStop(0.4, "rgba(255, 200, 100, 0.7)");
                flashGradient.addColorStop(0.8, "rgba(255, 100, 0, 0.5)");
                flashGradient.addColorStop(1, "rgba(255, 0, 0, 0)");
                
                ctx.fillStyle = flashGradient;
                ctx.beginPath();
                ctx.arc(size * 1.4, 0, 6 + Math.random() * 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Health indicator lights
            if (isYou) {
                ctx.fillStyle = healthRatio > 0.6 ? "#00ff00" : 
                              healthRatio > 0.3 ? "#ffff00" : "#ff0000";
                ctx.beginPath();
                ctx.arc(-3, -5, 1.5, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(-3, 5, 1.5, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Player name if not you
            if (!isYou && playerName) {
                ctx.save();
                ctx.rotate(-turret.angle); // Unrotate for text
                ctx.fillStyle = "white";
                ctx.strokeStyle = "black";
                ctx.font = "8px Arial";
                ctx.textAlign = "center";
                ctx.lineWidth = 0.5;
                ctx.strokeText(playerName, 0, -size * 1.5);
                ctx.fillText(playerName, 0, -size * 1.5);
                ctx.restore();
            }
        }
        
        // Helper functions for color manipulation
        function lightenColor(color, percent) {
            var num = parseInt(color.replace("#",""), 16);
            var amt = Math.round(2.55 * percent);
            var R = (num >> 16) + amt;
            var G = (num >> 8 & 0x00FF) + amt;
            var B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
        }
        
        function darkenColor(color, percent) {
            var num = parseInt(color.replace("#",""), 16);
            var amt = Math.round(2.55 * percent);
            var R = (num >> 16) - amt;
            var G = (num >> 8 & 0x00FF) - amt;
            var B = (num & 0x0000FF) - amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
        }
        
        // Draws turret
        function drawTurret(ps, isYou, isGhost) {
            var turret = ps.turret;
            var healthRatio = turret.life / 100;
            var alpha = !isYou ? transparency : 1;
            
            ctx.save();
            ctx.translate(getXOffset() + turret.x, getYOffset() + turret.y);
            ctx.rotate(turret.angle);
            ctx.globalAlpha = alpha;
            
            // Draw engine trails first (behind ship)
            drawEngineTrails(turret, isYou);
            
            // Draw main ship hull
            drawShipHull(turret, healthRatio, isYou);
            
            // Draw ship details and cockpit
            drawShipDetails(turret, healthRatio, isYou, ps.name);
            
            ctx.restore();
            
            // Handle recoil animation for firing effects
            if (turret.recoil > 0) {
                turret.recoil = turret.recoil - 1;
            }
		  //if (!isYou)alert("got here");
            if (isGhost) {
                ctx.save();
                if (!isYou) {
                    ctx.font = "4pt Palatino";
                    ctx.fillStyle = "white";
                    ctx.globalAlpha = .5;
                } else {
                    ctx.font = "bold 5pt Palatino";
                    ctx.fillStyle = "white";
                    ctx.globalAlpha = .8;
                }
                ctx.fillText(ps.getTimeLeft(), getXOffset() + turret.x - 14, getYOffset() + turret.y - 14);
                ctx.restore();
                ctx.save();
                ctx.translate(getXOffset() + turret.x, getYOffset() + turret.y);
                ctx.arc(0, 0, turret.length, 0, 2 * Math.PI, false);
                ctx.fillStyle = turret.color;
                ctx.globalAlpha = 0.1;
                ctx.fill();
                ctx.restore();
            } else {
                ctx.save();
                if (!isYou) {
                    ctx.font = "4pt Palatino";
                    ctx.fillStyle = "white";
                    ctx.globalAlpha = .8;
                } else {
                    ctx.font = "bold 5pt Palatino";
                    ctx.fillStyle = "white";
                    ctx.globalAlpha = 1;
                }
                ctx.fillText(ps.name, getXOffset() + turret.x - 14, getYOffset() + turret.y - 25);
                ctx.fillText(ps.kills, getXOffset() + turret.x - 14, getYOffset() + turret.y - 17);
                ctx.restore();
            }
        }

        function drawLocation() {
            // Draw location
            var ps = PlayerSession.all[sessionId];
            if (ps != null) {
                ctx.save();
                ctx.font = "6pt Courier New";
                ctx.fillStyle = "yellow";
                var x = PlayerSession.all[sessionId].turret.x;
                var y = PlayerSession.all[sessionId].turret.y;
                ctx.fillText("Location: " + x + "," +
                    y, 10, 25);
                ctx.restore();
            }
        }
        
        function drawNumPlayers() {
            ctx.save();
            ctx.font = "6pt Courier New";
            ctx.fillStyle = "white";
            ctx.fillText("# Players: " + Object.keys(PlayerSession.all).length, 600, 25);
            ctx.restore();
        }

        function drawScore() {
            ctx.save();
            ctx.font = "6pt Courier New";
            ctx.fillStyle = "white";
            ctx.fillText("" + score + " destroyed", 10, 480);
            ctx.restore();
        }

        function drawHelp() {
            ctx.save();
            ctx.font = "6pt Courier New";
            ctx.fillStyle = "greenyellow";
            ctx.fillText("INSTRUCTIONS : Move mouse to fly, auto-fires at enemies & shield asteroids | R=Restart, P=Pause", canvas.width/2/scale - 200, 25);
            ctx.restore();
        }

        function drawGameOver() { 
            //alert("draw game over"); 
            ctx.save();
            ctx.font = "bold 16pt Courier New";
            ctx.fillStyle = "yellow";
            ctx.fillText("Game Over", 40, 40);
            ctx.restore();
        }

        function drawGamePaused() {
            ctx.save();
            ctx.font = "bold 24pt Calibri";
            ctx.fillStyle = "#6495ED";
            ctx.fillText("(P)lay", 200, 100);
            ctx.restore();
        }

        function drawGameStart() {
            ctx.save();
            ctx.font = "bold 24pt Calibri";
            ctx.fillStyle = "#6495ED";
            ctx.fillText("(S)tart", 200, 100);
            ctx.restore();
        }

        function drawScores() {
            ctx.save();
            ctx.font = "6pt Palatino";
            ctx.fillStyle = "#6495ED";
            ctx.fillText("Leader Board : ", canvas.width/scale - 130, 50);
            ctx.restore();
            ctx.save();
            ctx.font = "6pt Palatino";
            ctx.fillStyle = "#b8c7e3";
            var inc = 20;
            //debug("scores " + scores);
            var cnt = 0;
            //var s = sortScores();
            for (var idx in scores) {
                if (cnt++ > 9) break;
                var sc = scores[idx];
                ctx.fillText("" + sc["n"] + " : " + sc["s"], canvas.width/scale - 130, 50 + inc);
                inc += 20;
            }
            ctx.restore();
         }

        function drawPlayerPowerUps() {
            ctx.save();
            ctx.font = "8pt Courier New";
            
            if (activePowerUp) {
                var color = getPowerUpColor(activePowerUp);
                var icon = getPowerUpIcon(activePowerUp);
                var name = getPowerUpName(activePowerUp);
                
                ctx.fillStyle = color;
                ctx.fillText("ACTIVE WEAPON:", 10, 50);
                ctx.font = "12pt Courier New";
                ctx.fillText(icon + " " + name, 10, 70);
            } else {
                ctx.fillStyle = "white";
                ctx.fillText("WEAPON: Normal", 10, 50);
            }
            
            ctx.restore();
        }

        function getPowerUpName(type) {
            switch(type) {
                case "rockets": return "ROCKETS";
                case "lasers": return "LASERS"; 
                case "spreadShot": return "SPREAD SHOT";
                case "rapidFire": return "RAPID FIRE";
                default: return "NORMAL";
            }
        }

        function getPowerUpIcon(type) {
            switch(type) {
                case "rockets": return "🚀";
                case "lasers": return "⚡"; 
                case "spreadShot": return "💥";
                case "rapidFire": return "⚡⚡";
                default: return "";
            }
        }

        function drawWorldPowerUps() {
            var time = Date.now() * 0.001; // time in seconds
            
            for (var key in PowerUp.all) {
                var powerUp = PowerUp.all[key];
                
                ctx.save();
                ctx.translate(getXOffset() + powerUp.x, getYOffset() + powerUp.y);
                
                // Floating/bobbing animation
                var bob = Math.sin(time * 2 + powerUp.bobOffset) * 3;
                ctx.translate(0, bob);
                
                // Rotation
                ctx.rotate(powerUp.rotation);
                
                // Glow effect
                ctx.shadowColor = getPowerUpColor(powerUp.type);
                ctx.shadowBlur = 15;
                
                // Draw power-up based on type
                drawPowerUpIcon(powerUp.type, powerUp.size);
                
                ctx.restore();
                
                // Draw pickup text
                ctx.save();
                ctx.font = "5pt Courier New";
                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                ctx.fillText(powerUp.type.toUpperCase(), 
                    getXOffset() + powerUp.x, 
                    getYOffset() + powerUp.y + powerUp.size + 8);
                ctx.restore();
            }
        }

        function getPowerUpColor(type) {
            switch(type) {
                case "rockets": return "orange";
                case "lasers": return "cyan"; 
                case "spreadShot": return "yellow";
                case "rapidFire": return "lime";
                default: return "white";
            }
        }

        function drawPowerUpIcon(type, size) {
            var color = getPowerUpColor(type);
            
            // Outer glow ring
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, 0, size, 0, Math.PI * 2);
            ctx.stroke();
            
            // Inner core
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.7;
            ctx.beginPath();
            ctx.arc(0, 0, size * 0.6, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;
            
            // Type-specific icon
            ctx.fillStyle = "white";
            ctx.font = (size * 0.8) + "pt Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            switch(type) {
                case "rockets": ctx.fillText("🚀", 0, 0); break;
                case "lasers": ctx.fillText("⚡", 0, 0); break;
                case "spreadShot": ctx.fillText("💥", 0, 0); break;
                case "rapidFire": ctx.fillText("⚡", 0, 0); break;
            }
        }
 
        function moveRocks() {
            for (var rockId in Rock.all) {
                if (Rock.all.hasOwnProperty(rockId)) {
                    var rock = Rock.all[rockId];
                    rock.x += rock.vx;
                    rock.y += rock.vy;
                    //rockCollideTurret(rock);
                    if (rock.x <= 0 || rock.y <= 0 || rock.x % canvas.width !== rock.x ||
                        rock.y % canvas.height !== rock.y) {
                        rock.remove();
                    }
                }
            }
        }

        function moveBullets() {
            for (var i in Bullet.all) {
                if (Bullet.all.hasOwnProperty(i)) {
                    var bullet = Bullet.all[i];
                    bullet.x += bullet.vx;
                    bullet.y += bullet.vy;
                    //bulletCollideRock(bullet);
                    if (bullet.x <= 0 || bullet.y <= 0 ||
                        bullet.x % canvas.width !== bullet.x ||
                        bullet.y % canvas.height !== bullet.y) {
                        bullet.remove();
                    }
                }
            }
        }
        // Bullet to Rock collision
        function bulletCollideRock(bullet) {
            for (var idx in Rock.all) {
                var rock = Rock.all[idx];
                if (distance(rock.x, rock.y, bullet.x, bullet.y) <= (bullet.r + rock.r)) {
                    bullet.remove();
                    if (rock.r < 20) {
                        rock.remove();
                        //score += 1;
                    } else {
                        rock.r = rock.r - 5;
                        rock.resize();
                    }
                    break;
                }
            }
        }
        //Rock to Turret collision
        function rockCollideTurret(rock) {
            if (distance(turret.x, turret.y, rock.x, rock.y) <= (5 + rock.r)) {
                //gameOver = 1;
                //scores = [];
                //socket.emit('submitscore', score);
            }
        }

        function distance(x1, y1, x2, y2) {
            var diffx = x2 - x1;
            var diffy = y2 - y1;
            return Math.sqrt(diffx * diffx + diffy * diffy);
        }

        function debug(info) {
            //alert(info);
            ctx.save();
            ctx.font = "6pt Courier New";
            ctx.fillStyle = "yellow";
            ctx.fillText("Debug: " + info, 10, 50);
            ctx.restore();
        }
        // Constructor
        function Turret(x, y, color) {
            this.x = x;
            this.y = y;
            this.length = 20;
            this.speed = 1;
            this.date = new Date();
            this.fillIdx = 0;
            this.hor = 0;
            this.ver = 0;
            this.color = color;
            this.angle = 0;
            this.baseRadius = 15;
            this.mousePosX = 250;
            this.mousePosY = 250;
            this.recoilX = 0;
            this.recoilY = 0;
            this.life = 100;
        }

        function PlayerSession(sessId, turret, timeLeft) {
            this.sessionId = sessId;
            this.turret = turret;
            this.moved = false;
            this.date = new Date();
            this.timeLeft = timeLeft;
            this.kills = 0;
            this.name = null;
            PlayerSession.all[this.sessionId] = this;
        }
        PlayerSession.all = {};
        PlayerSession.prototype = {
            remove: function() {
                //delete PlayerSession.all[this.sessionId];
                delete PlayerSession.all[this.sessionId];

            },
            getTimeLeft: function() {
                var t = Math.round(((this.date.getTime() + this.timeLeft - new Date().getTime())) / 1000);
                return t;
            }
        };
        // Constructor
        function Bullet(x, y, r, color, sessionId, id) {
            this.px = -1;
            this.py = -1;
            this.x = x;
            this.y = y;
            this.r = r;
            this.vx = 0;
            this.vy = 0;
            this.sessionId = sessionId;
            this.color = color;
            this.id = id;
            this.type = "normal"; // bullet type for power-ups
            Bullet.all[id] = this;
            this.cvs = null;
            this.cvsCtx = null;
        }
        Bullet.all = {};
        Bullet.draw_all = function() {
            for (var i in Bullet.all) {
                if (Bullet.all.hasOwnProperty(i)) {
                    Bullet.all[i].draw();
                }
            }
        };
        Bullet.prototype = {
            draw: function() {
                if (this.cvs == null) {
                    this.cvs = document.createElement("canvas");
                    this.cvs.width = this.r * 2 + 4; // extra space for effects
                    this.cvs.height = this.r * 2 + 4;
                    this.cvsCtx = this.cvs.getContext("2d");
                    this.cvsCtx.save();
                    
                    // Draw based on bullet type
                    if (this.type === "rockets" || this.color === "orange") {
                        // Rocket: proper rocket shape with flame trail
                        var centerX = this.r + 2;
                        var centerY = this.r + 2;
                        
                        // Calculate angle for rocket orientation
                        var angle = Math.atan2(this.vy, this.vx);
                        
                        this.cvsCtx.save();
                        this.cvsCtx.translate(centerX, centerY);
                        this.cvsCtx.rotate(angle);
                        
                        // Draw realistic rocket exhaust flames (behind rocket)
                        var speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                        var thrustPower = Math.min(speed / 2, 1); // Scale with rocket speed
                        var flameLength = this.r * (6 + thrustPower * 4); // Twice as long flames
                        var flameWidth = this.r * (1.2 + thrustPower * 0.5);
                        
                        // Pulsing flame effect for realistic engine burn
                        var flamePulse = 0.8 + 0.3 * Math.sin(Date.now() * 0.02);
                        flameLength *= flamePulse;
                        
                        // Main exhaust plume
                        var gradient = this.cvsCtx.createLinearGradient(-flameLength, 0, this.r * -0.2, 0);
                        gradient.addColorStop(0, "rgba(255, 0, 0, 0)");
                        gradient.addColorStop(0.2, "rgba(255, 50, 0, 0.4)");
                        gradient.addColorStop(0.5, "rgba(255, 150, 0, 0.8)");
                        gradient.addColorStop(0.8, "rgba(255, 255, 100, 0.9)");
                        gradient.addColorStop(1, "rgba(255, 255, 255, 1)");
                        
                        this.cvsCtx.fillStyle = gradient;
                        this.cvsCtx.beginPath();
                        this.cvsCtx.moveTo(-this.r * 0.1, 0);
                        this.cvsCtx.lineTo(-flameLength, -flameWidth/2);
                        this.cvsCtx.lineTo(-flameLength * 0.8, 0);
                        this.cvsCtx.lineTo(-flameLength, flameWidth/2);
                        this.cvsCtx.closePath();
                        this.cvsCtx.fill();
                        
                        // Inner core flame (bright white/blue)
                        var coreLength = flameLength * 0.6;
                        var coreWidth = flameWidth * 0.4;
                        var coreGradient = this.cvsCtx.createLinearGradient(-coreLength, 0, this.r * -0.1, 0);
                        coreGradient.addColorStop(0, "rgba(100, 150, 255, 0.3)");
                        coreGradient.addColorStop(0.5, "rgba(200, 200, 255, 0.8)");
                        coreGradient.addColorStop(1, "rgba(255, 255, 255, 1)");
                        
                        this.cvsCtx.fillStyle = coreGradient;
                        this.cvsCtx.beginPath();
                        this.cvsCtx.moveTo(-this.r * 0.05, 0);
                        this.cvsCtx.lineTo(-coreLength, -coreWidth/2);
                        this.cvsCtx.lineTo(-coreLength * 0.7, 0);
                        this.cvsCtx.lineTo(-coreLength, coreWidth/2);
                        this.cvsCtx.closePath();
                        this.cvsCtx.fill();
                        
                        // Draw homing indicator (pulsing glow around rocket)
                        var pulseAlpha = 0.2 + 0.3 * Math.sin(Date.now() * 0.008);
                        this.cvsCtx.shadowColor = "#00FF00"; // Green glow for homing
                        this.cvsCtx.shadowBlur = 12;
                        this.cvsCtx.globalAlpha = pulseAlpha;
                        this.cvsCtx.strokeStyle = "#00FF00";
                        this.cvsCtx.lineWidth = 2;
                        this.cvsCtx.beginPath();
                        this.cvsCtx.ellipse(0, 0, this.r * 1.5, this.r * 1.2, 0, 0, Math.PI * 2);
                        this.cvsCtx.stroke();
                        this.cvsCtx.globalAlpha = 1;
                        this.cvsCtx.shadowBlur = 0;
                        
                        // Draw rocket body (slightly larger)
                        this.cvsCtx.fillStyle = "#C0C0C0"; // Silver body
                        this.cvsCtx.strokeStyle = "#333";
                        this.cvsCtx.lineWidth = 1;
                        this.cvsCtx.beginPath();
                        this.cvsCtx.ellipse(0, 0, this.r * 1.1, this.r * 0.7, 0, 0, Math.PI * 2);
                        this.cvsCtx.fill();
                        this.cvsCtx.stroke();
                        
                        // Draw rocket nose (pointed tip)
                        this.cvsCtx.fillStyle = "#FF4500"; // Orange tip
                        this.cvsCtx.beginPath();
                        this.cvsCtx.moveTo(this.r * 1.1, 0);
                        this.cvsCtx.lineTo(this.r * 0.3, -this.r * 0.45);
                        this.cvsCtx.lineTo(this.r * 0.3, this.r * 0.45);
                        this.cvsCtx.closePath();
                        this.cvsCtx.fill();
                        
                        // Draw fins
                        this.cvsCtx.fillStyle = "#8B0000"; // Dark red fins
                        this.cvsCtx.beginPath();
                        this.cvsCtx.moveTo(-this.r * 0.5, -this.r * 0.6);
                        this.cvsCtx.lineTo(-this.r * 0.8, -this.r * 0.9);
                        this.cvsCtx.lineTo(-this.r * 0.3, -this.r * 0.6);
                        this.cvsCtx.closePath();
                        this.cvsCtx.fill();
                        
                        this.cvsCtx.beginPath();
                        this.cvsCtx.moveTo(-this.r * 0.5, this.r * 0.6);
                        this.cvsCtx.lineTo(-this.r * 0.8, this.r * 0.9);
                        this.cvsCtx.lineTo(-this.r * 0.3, this.r * 0.6);
                        this.cvsCtx.closePath();
                        this.cvsCtx.fill();
                        
                        this.cvsCtx.restore();
                    } else if (this.type === "lasers" || this.color === "cyan") {
                        // Laser: bright glowing bullet
                        var gradient = this.cvsCtx.createRadialGradient(this.r + 2, this.r + 2, 0, this.r + 2, this.r + 2, this.r + 1);
                        gradient.addColorStop(0, "white");
                        gradient.addColorStop(0.5, "cyan");
                        gradient.addColorStop(1, "blue");
                        this.cvsCtx.fillStyle = gradient;
                        this.cvsCtx.beginPath();
                        this.cvsCtx.arc(this.r + 2, this.r + 2, this.r, 0, Math.PI * 2, true);
                        this.cvsCtx.closePath();
                        this.cvsCtx.fill();
                    } else if (this.type === "spreadShot" || this.color === "yellow") {
                        // Spread shot: jagged bullet
                        this.cvsCtx.fillStyle = "yellow";
                        this.cvsCtx.strokeStyle = "orange";
                        this.cvsCtx.lineWidth = 1;
                        this.cvsCtx.beginPath();
                        // Create a star shape
                        var spikes = 6;
                        var step = Math.PI / spikes;
                        var innerRadius = this.r * 0.5;
                        var outerRadius = this.r;
                        for (var i = 0; i < spikes * 2; i++) {
                            var radius = (i % 2 === 0) ? outerRadius : innerRadius;
                            var x = (this.r + 2) + Math.cos(i * step) * radius;
                            var y = (this.r + 2) + Math.sin(i * step) * radius;
                            if (i === 0) this.cvsCtx.moveTo(x, y);
                            else this.cvsCtx.lineTo(x, y);
                        }
                        this.cvsCtx.closePath();
                        this.cvsCtx.fill();
                        this.cvsCtx.stroke();
                    } else {
                        // Normal bullet or rapid fire
                        this.cvsCtx.fillStyle = this.color;
                        this.cvsCtx.strokeStyle = "black";
                        this.cvsCtx.beginPath();
                        this.cvsCtx.arc(this.r + 2, this.r + 2, this.r, 0, Math.PI * 2, true);
                        this.cvsCtx.closePath();
                        this.cvsCtx.fill();
                        this.cvsCtx.stroke();
                    }
                    this.cvsCtx.restore();
                }
                ctx.save();
                ctx.translate(getXOffset() + this.x, getYOffset() + this.y);
                ctx.drawImage(this.cvs, -this.r - 2, -this.r - 2);
                ctx.restore();
            },
            remove: function() {
                //alert("bullet " + Bullet.all[this.id]);
                delete Bullet.all[this.id];
            }
        };

        Bullet.deserialize = function(data) {
            var bullet = new Bullet(data["x"], data["y"], data["r"], data["color"], data["sessionId"], data["id"]);
            bullet.vx = data["vx"];
            bullet.vy = data["vy"];
            bullet.type = data["type"] || "normal";
        };

        Bullet.moveBullet = function(data) {
            //debug("bullet : " + data);
            var bullet = Bullet.all[data["id"]];          
            if (bullet == null) {
                socket.emit("gb", {"id": data["id"]});
            } else {
                //debug("bullet : " + bullet);
                bullet.px = bullet.x;
                bullet.py = bullet.y;
                bullet.x = data["x"];
                bullet.y = data["y"];
                
                // Update velocity for rockets (needed for proper rotation)
                if (data["vx"] !== undefined) bullet.vx = data["vx"];
                if (data["vy"] !== undefined) bullet.vy = data["vy"];
                
                // Force canvas redraw for rockets (their rotation changes)
                if (bullet.type === "rockets") {
                    bullet.cvs = null; // Force redraw with new angle
                }
            }
        };

        function Coord(x, y) {
            this.x = x;
            this.y = y;
        }
        // Constructor
        function Rock(x, y, r, id) {
            this.color = "white";
            this.x = x;
            this.y = y;
            this.r = r;
            this.angle = 0;
            this.vx = 0;
            this.vy = 0;
            this.jaggedNess = 10;
            this.coords = [];
            this.drawangle = 0;
            this.spinDirection = 1;
            this.numEdges = 18;
            this.id = id; 
            this.cvs = null;
            this.cvsCtx = null;
        }
        Rock.all = {};
        Rock.deserialize = function(data) {
            var rock = new Rock(data["x"], data["y"], data["r"], data["id"]);
            rock.color = data["color"];
            rock.angle = data["angle"];
            rock.vx = data["vx"];
            rock.vy = data["vy"];
            rock.jaggedNess = data["jaggedNess"];
            rock.coords = data["coords"];
            rock.drawangle = data["drawangle"];
            rock.spinDirection = data["spinDirection"];
            rock.numEdges = data["numEdges"];
            return rock;
        };
        Rock.draw_all = function() {
            for (var idx in Rock.all) {
                if (Rock.all.hasOwnProperty(idx)) {
                    Rock.all[idx].draw();
                }
            }
        };

        Rock.moveRock = function(data) {
            var rock = Rock.all[data["id"]];
            if (rock == null) {
                //alert("null rock");
                socket.emit("gr", {"id" : data["id"]});
            }
            else {
                rock.x = data["x"];
                rock.y = data["y"];
            }
        };

        Rock.prototype = {
            remove: function() {
                delete Rock.all[this.id];
            },
            // Helper functions for color manipulation
            lightenColor: function(color, percent) {
                var num = parseInt(color.replace("#",""), 16),
                    amt = Math.round(2.55 * percent),
                    R = (num >> 16) + amt,
                    G = (num >> 8 & 0x00FF) + amt,
                    B = (num & 0x0000FF) + amt;
                return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
            },
            darkenColor: function(color, percent) {
                var num = parseInt(color.replace("#",""), 16),
                    amt = Math.round(2.55 * percent),
                    R = (num >> 16) - amt,
                    G = (num >> 8 & 0x00FF) - amt,
                    B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
            },
            draw: function() {
                if (this.cvs == null) {
                    this.cvs = document.createElement("canvas");
                    this.cvs.width = this.r * 2;
                    this.cvs.height = this.r * 2;
                    this.cvsCtx = this.cvs.getContext("2d");
                    this.cvsCtx.save();
                    
                    // Create realistic asteroid appearance
                    var centerX = this.r;
                    var centerY = this.r;
                    
                    // Base asteroid colors (darker, more rock-like)
                    var baseColors = ["#4a4a4a", "#5c5c5c", "#3d3d3d", "#6b6b6b", "#2f2f2f"];
                    var isShieldRegen = this.color == "lightblue";
                    var baseColor = isShieldRegen ? "#4a5a6a" : (baseColors[Math.floor(Math.abs(this.x + this.y) % baseColors.length)]); // Slightly blue tint for shield rocks
                    
                    // Create radial gradient for depth
                    var gradient = this.cvsCtx.createRadialGradient(centerX * 0.7, centerY * 0.7, 0, centerX, centerY, this.r);
                    gradient.addColorStop(0, this.lightenColor(baseColor, 30));
                    gradient.addColorStop(0.6, baseColor);
                    gradient.addColorStop(1, this.darkenColor(baseColor, 40));
                    
                    this.cvsCtx.fillStyle = gradient;
                    this.cvsCtx.strokeStyle = this.darkenColor(baseColor, 20);
                    this.cvsCtx.lineWidth = 2;
                    
                    // Draw jagged, irregular asteroid shape
                    this.cvsCtx.beginPath();
                    var isFirst = true;
                    for (var idx in this.coords) {
                        var coord = this.coords[idx];
                        // Add some random jaggedness to make it more asteroid-like
                        var jitter = this.r * 0.1;
                        var jitterX = (Math.sin(coord[0] * 0.1 + this.x) * jitter);
                        var jitterY = (Math.cos(coord[1] * 0.1 + this.y) * jitter);
                        
                        var x = coord[0] + this.r + jitterX;
                        var y = coord[1] + this.r + jitterY;
                        
                        if (isFirst) {
                            this.cvsCtx.moveTo(x, y);
                            isFirst = false;
                        } else {
                            this.cvsCtx.lineTo(x, y);
                        }
                    }
                    this.cvsCtx.closePath();
                    this.cvsCtx.fill();
                    this.cvsCtx.stroke();
                    
                    // Add some crater-like details
                    this.cvsCtx.fillStyle = this.darkenColor(baseColor, 30);
                    for (var i = 0; i < 3; i++) {
                        var craterX = centerX + (Math.sin(i * 2.1 + this.x * 0.01) * this.r * 0.3);
                        var craterY = centerY + (Math.cos(i * 1.7 + this.y * 0.01) * this.r * 0.3);
                        var craterSize = this.r * (0.1 + Math.abs(Math.sin(i + this.x * 0.01)) * 0.1);
                        
                        this.cvsCtx.beginPath();
                        this.cvsCtx.arc(craterX, craterY, craterSize, 0, 2 * Math.PI);
                        this.cvsCtx.fill();
                    }
                    
                    // Special effects for shield regeneration asteroids
                    if (isShieldRegen) {
                        // Add glowing blue crystals embedded in the rock surface
                        this.cvsCtx.save();
                        
                        // Draw energy crystals at various points
                        var crystalPositions = [
                            {x: centerX * 0.6, y: centerY * 0.7, size: 0.15},
                            {x: centerX * 1.3, y: centerY * 0.8, size: 0.12},
                            {x: centerX * 0.8, y: centerY * 1.4, size: 0.18},
                            {x: centerX * 1.2, y: centerY * 1.2, size: 0.10}
                        ];
                        
                        for (var j = 0; j < crystalPositions.length; j++) {
                            var crystal = crystalPositions[j];
                            var crystalSize = this.r * crystal.size;
                            
                            // Create glowing crystal gradient
                            var crystalGradient = this.cvsCtx.createRadialGradient(
                                crystal.x, crystal.y, 0,
                                crystal.x, crystal.y, crystalSize
                            );
                            crystalGradient.addColorStop(0, "#88ddff");
                            crystalGradient.addColorStop(0.7, "#2299cc");
                            crystalGradient.addColorStop(1, "#004466");
                            
                            this.cvsCtx.fillStyle = crystalGradient;
                            this.cvsCtx.beginPath();
                            this.cvsCtx.arc(crystal.x, crystal.y, crystalSize, 0, 2 * Math.PI);
                            this.cvsCtx.fill();
                            
                            // Add bright crystal core
                            this.cvsCtx.fillStyle = "#aaeeff";
                            this.cvsCtx.beginPath();
                            this.cvsCtx.arc(crystal.x, crystal.y, crystalSize * 0.4, 0, 2 * Math.PI);
                            this.cvsCtx.fill();
                        }
                        
                        this.cvsCtx.restore();
                    }
                    this.cvsCtx.restore();
                }
                ctx.save();
                ctx.translate(getXOffset() + this.x, getYOffset() + this.y);
                ctx.rotate(this.drawangle * Math.PI / 180);
                this.drawangle = (this.drawangle + (1 * this.spinDirection)) % 360;
                
                // Add dynamic effects for shield regeneration asteroids
                if (this.color == "lightblue") {
                    var time = Date.now() * 0.003;
                    
                    // Pulsing energy aura around the asteroid
                    var pulseIntensity = 0.6 + 0.4 * Math.sin(time);
                    var auraRadius = this.r * (1.3 + 0.2 * Math.sin(time * 1.5));
                    
                    // Outer energy glow
                    var auraGradient = ctx.createRadialGradient(0, 0, this.r * 0.8, 0, 0, auraRadius);
                    auraGradient.addColorStop(0, "rgba(102, 204, 255, 0)");
                    auraGradient.addColorStop(0.7, "rgba(102, 204, 255, " + (0.1 * pulseIntensity) + ")");
                    auraGradient.addColorStop(1, "rgba(50, 150, 255, " + (0.3 * pulseIntensity) + ")");
                    
                    ctx.fillStyle = auraGradient;
                    ctx.beginPath();
                    ctx.arc(0, 0, auraRadius, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Energy particles floating around the asteroid
                    for (var p = 0; p < 8; p++) {
                        var particleAngle = (time + p * 0.8) % (2 * Math.PI);
                        var particleDistance = this.r * (1.2 + 0.3 * Math.sin(time * 2 + p));
                        var particleX = Math.cos(particleAngle) * particleDistance;
                        var particleY = Math.sin(particleAngle) * particleDistance;
                        var particleAlpha = 0.4 + 0.4 * Math.sin(time * 3 + p * 1.2);
                        
                        ctx.fillStyle = "rgba(150, 220, 255, " + particleAlpha + ")";
                        ctx.beginPath();
                        ctx.arc(particleX, particleY, 2, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        // Add small glow around each particle
                        ctx.fillStyle = "rgba(200, 240, 255, " + (particleAlpha * 0.3) + ")";
                        ctx.beginPath();
                        ctx.arc(particleX, particleY, 4, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                }
                
                ctx.drawImage(this.cvs, -this.r, -this.r);
                ctx.restore();
            }
        };
        // Adding in various event handlers
        canvas.addEventListener('mousemove', function(evt) {
            getMousePos(canvas, evt);
        }, false);
        canvas.addEventListener('mousedown', function(evt) {
            if (gamePaused == 1 || gameOver == 1) return;
            mouseDown = 1;
            if (socket != null)
                socket.emit("md");
        }, false);
        canvas.addEventListener('mouseup', function(evt) {
            mouseDown = 0;
            if (socket != null)
                socket.emit("mu");
        }, false);
        canvas.onselectstart = function() {
            return false;
        }

        function drawInputName() {
            ctx.save();
            ctx.font = "12pt Courier New";
            ctx.fillStyle = "yellow";
            var x = PlayerSession.all[sessionId].turret.x;
            var y = PlayerSession.all[sessionId].turret.y;
            ctx.fillText("Enter nick name: " + nickName, 10, 20);
            ctx.fillText("Push <Enter> to continue", 10, 40);
            ctx.restore();
        }


        function drawStars() {
            if (starsCanvas == null) return;
            ctx.save();
            if(starsPositions.length > 0) 
                ctx.drawImage(starsCanvas, -getXOffset(), -getYOffset(), canvas.width/scale, canvas.height/scale, 0, 0, canvas.width/scale, canvas.height/scale);
            else 
                ctx.drawImage(starsCanvas, 0, 0, canvas.width/scale, canvas.height/scale, 0, 0, canvas.width/scale, canvas.height/scale);
            ctx.restore();
            //alert("draw stars");
        }

        {
            starsCanvas = document.createElement("canvas");
            starsCanvas.width = MAX_X;
            starsCanvas.height = MAX_Y;
            starsCtx = starsCanvas.getContext("2d");
            starsCtx.save();
            starsCtx.fillStyle = "black";
            starsCtx.fillRect(0, 0, starsCanvas.width, starsCanvas.height);
            starsCtx.restore();
        }

        var lastSyncCheck = 0;
        
        function drawWorld() {
              requestAnimationFrame(drawWorld);
              removeStuff(); 
              drawStars();
              
              // Periodic sync check (every 5 seconds)
              var now = Date.now();
              if (now - lastSyncCheck > 5000 && socket && sessionId) {
                  lastSyncCheck = now;
                  // Request server to confirm our power-up state
                  socket.emit("syncPowerUp", { sessionId: sessionId });
              }
              
              ctx.save();
              ctx.lineWidth = 2;
              ctx.strokeStyle = "#6495ED";
              ctx.strokeRect(2, 2, canvas.width/scale - 4, canvas.height/scale - 4);
              ctx.restore();
              drawTurrets();
              Bullet.draw_all();
              Rock.draw_all();
              drawWorldPowerUps(); // Draw power-ups floating in space
              drawScores();
              drawHelp();
              drawLocation();
              drawPlayerPowerUps(); // Draw player's current power-ups in UI
        }
        drawWorld();
    </script>
</body>

</html>
