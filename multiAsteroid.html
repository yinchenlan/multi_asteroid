<html>
<head>
    <meta charset="utf-8">
    <!--<meta name="viewport" content="width=device-width, user-scalable=no">-->
    <title>Space Shooter Game</title>
    <style>
      html, body {
      width: 100%;
      height: 100%;
      margin: 0px;
      border: 0;
      overflow: hidden; /*  Disable scrollbars */
      display: block;  /* No floating content on sides */
      }
    </style>
</head>
<script src="/socket.io/socket.io.js"></script>

<body style="background-color:lightgrey;">
    <table>
        <tr>
            <td>
                <canvas id="gameCanvas"></canvas>
                <audio id="laser" src="laser.wav" style="display: none;"></audio>
                <form name = "nameForm" action="#"> 
                <font color="blue">Enter Name: </font><input type="text" name="nickName">
                <input type="submit" value="Start" onclick="socket = connect(); updateSocket(); setNickName(); hideForm(); return false;">
                </form> 
            </td>
        </tr>
    </table>
    <script>
        /**
         * An Asteroid-like game.
         * Author: Chuck Lan
         **/
        function serverLog(msg) {
            socket.emit("serverLog", {
                "log": msg
            });
        }

        function initialize() {
	    // Register an event listener to
	    // call the resizeCanvas() function each time 
	    // the window is resized.
	    window.addEventListener('resize', resizeCanvas, false);
	
	    // Draw canvas border for the first time.
	    resizeCanvas();
            //alert("resized");
	}

        function resizeCanvas() {
	    canvas.width = window.innerWidth - 10;
	    canvas.height = window.innerHeight - 30;
            updateScale();
            if (socket != null)
                socket.emit("wr", {"sId": sessionId, "s": scale, "w": canvas.width, "h": canvas.height});
	}
        
        function setNickName() {
            nickName = document.nameForm.nickName.value;
        }

        function hideForm() {
            document.nameForm.style.display="none";
        }
        
        function unhideForm() {
            document.nameForm.style.display="block";
        }

        function getXOffset() {
            if (sessionId != null && PlayerSession.all[sessionId] != null) {
                var negX = -1 * PlayerSession.all[sessionId].turret.x;
                var offset = negX + canvas.width/2/scale;
	        if (PlayerSession.all[sessionId].turret.x < canvas.width/2/scale) {
	            return 0;
                } else if (PlayerSession.all[sessionId].turret.x > MAX_X - canvas.width/2/scale) {
	            return -(MAX_X - canvas.width/scale);
	        }
                return offset; 
            }
            return 0;
        }

        function getYOffset() {
            if (sessionId != null && PlayerSession.all[sessionId] !=null) {
                var negY = -1 * PlayerSession.all[sessionId].turret.y;
                var offset = negY + gameCanvas.height/2/scale;
                if (PlayerSession.all[sessionId].turret.y < canvas.height/2/scale) {
		    return 0;       
                } else if (PlayerSession.all[sessionId].turret.y > MAX_Y - canvas.height/2/scale) {
	            return -(MAX_Y - canvas.height/scale);
                }
                return offset;
            }
            return 0;
        }

        function getMousePos(canvas, evt) {
            // get canvas position
            var obj = canvas;
            var top = 0;
            var left = 0;
            while (obj && obj.tagName != 'BODY') {
                top += obj.offsetTop;
                left += obj.offsetLeft;
                obj = obj.offsetParent;
            }
            // return relative mouse position
            var ps = PlayerSession.all[sessionId];
            if (ps != null) {
                var turret = ps.turret;
                turret.mousePosX = (-getXOffset() + evt.clientX / scale - left + window.pageXOffset);
                turret.mousePosY = (-getYOffset() + evt.clientY / scale - top + window.pageYOffset);
                socket.emit("mousePos", {
                    "mousePosX": turret.mousePosX,
                    "mousePosY": turret.mousePosY
                });
            }
        }
        var hor = 0,
            ver = 0,
            score = 0,
            gameOver = 0,
            gamePaused = 0,
            started = 0,
            mouseDown = 0,
            endscoresend = 0;
        var rockDate = new Date();
        var mouseDate = new Date();
        var scores = [];
        //var unsortedScores = [];
        var socket = null;
        var sessionId = null;
        var transparency = 0.4;
        var starsPositions = [];
        var nickName = "";
        var deleteRockSet = {};
        var deleteBulletSet = {};
        var deletePlayerSessionSet = {};
        var MAX_X = 3200;
        var MAX_Y = 2400;
        var WINDOW_X_SIZE = 800;
        var WINDOW_Y_SIZE = 600;
        var starsCanvas = null;
        var starsCtx = null;
        var scale = 1;

        function updateScale() {
            var scaleX = canvas.width / WINDOW_X_SIZE;
            var scaleY = canvas.height / WINDOW_Y_SIZE;
            scale = Math.max(1, Math.max(scaleX, scaleY));
            ctx.scale(scale, scale);
        }

        function strcmp(a, b) {
            if (a.toString() < b.toString()) return -1;
            if (a.toString() > b.toString()) return 1;
            return 0;
        }

	function sortScores() {
            var rv = scores.splice(0);
            if (rv != null) {
                rv.sort(function(a, b) {
                    var diff = b["s"] - a["s"];
                    //if (diff > 0) alert("diff " + diff);
	            if (diff == 0) diff = strcmp(b["n"], a["n"]);
                    //if (diff != 0) alert("diff " + diff);
                    return diff;
	        });
            }
            return rv;
        }

        var laser = document.getElementById("laser");


        function connect() {
            gameOver = 0;
            return io.connect(location.hostname + ':' + location.port, 
            {transports: ['websocket']});
        }

        function updateSocket() {
            socket.on("connected", function(data) {
                var turret = new Turret(data["x"], data["y"], data["color"]);
                turret.life = data["life"];
                sessionId = data["sessionId"];
                var ps = new PlayerSession(sessionId, turret, data["timeLeft"]);
                //alert("Creating player session " + sessionId);
                setNickNameToPlayerSession();
                socket.emit("wr", {"sId": sessionId, "s": scale, "w": canvas.width, "h": canvas.height});
            });

            socket.on("rp", function(data) {
                //alert("deleting " + data["sId"]);
                //delete PlayerSession.all[data["sId"]];
                deletePlayerSessionSet[data["sId"]] = 1;
            });

            socket.on("gb", function(data) {
                var bullet = Bullet.deserialize(data);
            });

            socket.on("lb", function(data) {
                if (data["ss"] != null) { 
                    scores = data["ss"];
                    scores = sortScores();      
                    //alert("lb " + scores.length);
                }
            });

            socket.on("stars", function(data) {
                starsPositions = data["stars"];
                starsCanvas = document.createElement("canvas");
                starsCanvas.width = MAX_X;
                starsCanvas.height = MAX_Y;
                starsCtx = starsCanvas.getContext("2d");
                starsCtx.save();
                starsCtx.fillStyle = "black";
                starsCtx.fillRect(0, 0, starsCanvas.width, starsCanvas.height);
                starsCtx.restore();
                for (var i in starsPositions) {
                    //alert("i " + i);
                    var pos = starsPositions[i];
                    var x = pos[0];
                    var y = pos[1];
                    //alert("x " + x + ", y " + y);
                    starsCtx.save();
                    starsCtx.translate(x, y);
                    starsCtx.fillStyle = "yellow";
                    starsCtx.strokeStyle = "yellow";
                    starsCtx.beginPath();
                    starsCtx.arc(0, 0, 1, 0, Math.PI * 2, true);
                    starsCtx.closePath();
                    starsCtx.fill();
                    starsCtx.stroke();
                    starsCtx.restore();
                }

            });

            socket.on("createRock", function(data) {
                var rock = Rock.deserialize(data);
                Rock.all[rock.id] = rock;
            });

            socket.on("readscore", function(data) {
                //debug("scores " + scores);
                if (data > 0) {
                    scores.push(data);
                }
            });

            socket.on("endscoresend", function() {
                endscoresend = 1;
            });

            socket.on("updateWorld", function(data) {
                //debug("updateWorld");
                var me = PlayerSession.all[sessionId];
                PlayerSession.all = {};
                PlayerSession.all[sessionId] = me;
                executeCommands(data["updateWorld"]);
                //drawWorld();
            });
        }

        function removePlayer(data) {
            var ps = PlayerSession.all[data];
            if (ps != null) {
                ps.remove();
                delete deletePlayerSessionSet[data];
                if (data == sessionId) {
                    socket.disconnect();
                    gameOver = 1;
                    Rock.all = {};
                    Bullet.all = {};
                    PlayerSession.all = {};
                    deletePlayerSessionSet = {};
                    deleteRockSet = {};
                    deleteBulletSet = {};
                    unhideForm();
                }
            }
        };

        function damagePlayer(data) {
            //debug("damagePlayer");
            var ps = PlayerSession.all[data["sessionId"]];
            if (ps != null)
                ps.turret.life = data["life"];
        };


        function createRock(data) {
            //debug("createRock");
            var rock = Rock.deserialize(data);
            Rock.all[rock.id] = rock;
        };

        function resizeRock(data) {
            //debug("resizeRock");
            var rock = Rock.deserialize(data);
            Rock.all[rock.id] = rock;
        };

        function createBullet(data) {
            //debug("createBullet");
            var bullet = new Bullet(data["x"], data["y"], data["r"], data["color"], data["sessionId"], data["id"]);
            bullet.vx = data["vx"];
            bullet.vy = data["vy"];
            //laser.play();

        };

        function removeBullet(data) {
            //alert("removeBullet " + data["id"]);
            if (Bullet.all[data] != null) {
                //alert("remove bullet "  + data);
                delete Bullet.all[data];
                delete deleteBulletSet[data];
            }
        };

        function removeRock(data) {
            //alert("removeRock " + data["id"]);
            if(Rock.all[data] != null) {
                delete Rock.all[data];
                delete deleteRockSet[data];
            }
        };


        function turretMove(data) {
                var turretMove = data;
                var sessId = turretMove["sId"];
                var x = turretMove["x"];
                var y = turretMove["y"];
                var color = turretMove["c"];
                var recoil = turretMove["r"];
                var recoilX = turretMove["rx"];
                var recoilY = turretMove["ry"];
                var mousePosX = turretMove["mpx"];
                var mousePosY = turretMove["mpy"];
                var angle = turretMove["a"];
                var name = turretMove["n"];
                var ps = PlayerSession.all[sessId];
                if (ps == null) {
                    var turret = new Turret(x, y, color);
                    //alert("creating new player session " + sessId);
                    ps = new PlayerSession(sessId, turret, turretMove["tl"]);
                }
                ps.name = name;
                ps.kills = turretMove["k"];
                var turret = ps.turret;
                turret.x = x;
                turret.y = y;
                turret.color = color;
                turret.mousePosX = mousePosX;
                turret.mousePosY = mousePosY;
                turret.angle = angle;
                turret.recoil = recoil;
                turret.recoilX = recoilX;
                turret.recoilY = recoilY;
                turret.life = turretMove["l"];
        };

        function executeCommands(commands) {
            //debug("command length : " + commands.length);
            for (var idx in commands) {
                var cmd = commands[idx];
                //if (cmd[0] == "removePlayer") alert ("hi ");
                executeCommand(commands[idx]);
            }
        }

        function removeStuff() {
            for (var key in deleteBulletSet) {
                removeBullet(key);
                //delete deleteBulletSet[key];
            }
            for (var key in Bullet.all) {
                var bullet = Bullet.all[key];
                var x = bullet.x + getXOffset();
                var y = bullet.y + getYOffset();
                if (x < -100 || x > 900 || y < -100 || y > 700) 
                    bullet.remove();
            }
            
            for (var key in deletePlayerSessionSet) {
                //alert("remove player " + key);
                removePlayer(key);
                //delete deletePlayerSessionSet[key];
            }
            /*
            for (var key in PlayerSession.all) {
		var ps = PlayerSession.all[key];
		var x = ps.turret.x + getXOffset();
		var y = ps.turret.y + getYOffset();
		if (x < -100 || x> 900 ||y < -100 || y > 700)
                    ps.remove();
            }*/
            
            for (var key in deleteRockSet) {
                removeRock(key);
                //delete deleteRockSet[key];
            }

            for (var key in Rock.all) {
                var rock = Rock.all[key];
                var x = rock.x + getXOffset();
                var y = rock.y + getYOffset();
                if (x < -100 || x> 900 ||y < -100 || y > 700) 
                    rock.remove();
            }

            //Bullet.removeDeadBullets();
        }

        function executeCommand(command) {
            //if (command[0] == "removePlayer") alert ("remove " + command[1]["sessionId"]);
            //debug("command : " + command[0]);
            switch (command[0]) {
                case "removePlayer":
                    //alert("remove player abc " + command[1]["sessionId"]);
                    //deletePlayerSessionSet[command[1]["sessionId"]] = 1;
                    //removePlayer(command[1]);
                    break;
                case "damagePlayer":
                    damagePlayer(command[1]);
                    break;
                case "createRock":
                    createRock(command[1]);
                    break;
                case "resizeRock":
                    resizeRock(command[1]);
                    break;
                case "createBullet":
                    createBullet(command[1]);
                    break;
                case "removeBullet":
                    deleteBulletSet[command[1]["id"]] = 1;
                    //removeBullet(command[1]);
                    break;
                case "removeRock":
                    deleteRockSet[command[1]["id"]] = 1;
                    //removeRock(command[1]);
                    break;
                case "tm":
                    turretMove(command[1]);
                    break;
                case "updateRock":
                    Rock.moveRock(command[1]);
                    break;
                case "updateBullet":
                    Bullet.moveBullet(command[1]);
                    break;
            }
        }

        var canvas = document.getElementById("gameCanvas");
        canvas.style.backgroundColor = 'black';
        var ctx = canvas.getContext('2d');

        initialize();

        function resetGame() {
            var ps = PlayerSession.all[sessionId];
            ps.remove();
            socket.socket.reconnect();
        }

        function pauseGame() {
            if (gamePaused == 1) {
                gamePaused = 0;
            } else {
                gamePaused = 1;
            }
        }

        function isValidNameChar(ch) {
            return ch == 8 || ch == 13 || (ch >= 48 && ch <= 57) ||
                (ch >= 65 && ch <= 90) || (ch >= 97 && ch <= 122);
        }

        function setNickNameToPlayerSession() {
            PlayerSession.all[sessionId].name = nickName;
            socket.emit("nickName", {
                "sessionId": sessionId,
                "name": nickName
            });
            //alert("nickname sent " + nickName); 
        }

        window.addEventListener('keydown', function(event) {
            switch (event.keyCode) {
                case 87:
                    /* Up arrow was pressed */
                    if (gamePaused == 0 && gameOver == 0)
                        ver = -1;
                    break;
                case 83:
                    /* Down arrow was pressed */
                    if (gamePaused == 0 && gameOver == 0)
                        ver = 1;
                    break;
                case 65:
                    /* Left arrow was pressed */
                    if (gamePaused == 0 && gameOver == 0)
                        hor = -1;
                    break;
                case 68:
                    /* Right arrow was pressed */
                    if (gamePaused == 0 && gameOver == 0)
                        hor = 1;
                    break;
                case 82:
                    /* Restart */
                    resetGame();
                    break;
                case 83:
                    /* Start */
                    started = 1;
                    break;
                case 80:
                    /* Pause/Unpause */
                    if (started == 1)
                        pauseGame();
                    break;
            }
            //if (event.preventDefault) { event.preventDefault(); }
            //if (event.stopPropagation) { event.stopPropagation(); }
            //Locally move the turret
            //alert("sessionId " + sessionId);
            //var ps = PlayerSession.all[sessionId];
            //if (hor != 0 && ver != 0) {
            //    var speed = ps.turret.speed * Math.cos(Math.PI / 4);
            //    ps.turret.x = Math.round(ps.turret.x + hor * speed);
            //    ps.turret.y = Math.round(ps.turret.y + hor * speed);
            //} else if (hor == 0 && ver != 0) {
            //    ps.turret.y = Math.round(ps.turret.y + hor * ps.turret.speed);
            //} else if (ver == 0 && hor != 0) {
            //    ps.turret.x = Math.round(ps.turret.x + hor * ps.turret.speed);
            //}
            if (socket != null)
                socket.emit("moveStart", {
                    "sessionId": sessionId,
                    "hor": hor,
                    "ver": ver
                }); 
            //debug("turret x : " + PlayerSession.all[sessionId].turret.x + ", y : " + PlayerSession.all[sessionId].turret.y);
        }, true);
        window.addEventListener('keyup', function(event) {
            switch (event.keyCode) {
                case 87:
                    /* Up arrow was pressed */
                    if (gamePaused == 0 && gameOver == 0)
                        ver = 0;
                    break;
                case 83:
                    /* Down arrow was pressed */
                    if (gamePaused == 0 && gameOver == 0)
                        ver = 0;
                    break;
                case 65:
                    /* Left arrow was pressed */
                    if (gamePaused == 0 && gameOver == 0)
                        hor = 0;
                    break;
                case 68:
                    /* Right arrow was pressed */
                    if (gamePaused == 0 && gameOver == 0)
                        hor = 0;
                    break;
            }
            //if (event.preventDefault) { event.preventDefault(); }
            //if (event.stopPropagation) { event.stopPropagation(); }
            if (socket != null) 
                socket.emit("moveEnd", {
                    "sessionId": sessionId
                }); 
            //debug("turret x : " + PlayerSession.all[sessionId].turret.x + ", y : " + PlayerSession.all[sessionId].turret.y);
        }, true);

        function drawTurrets() {
            for (var key in PlayerSession.all) {
                if (PlayerSession.all.hasOwnProperty(key)) {
                    var ps = PlayerSession.all[key];
                    var isYou = (ps.sessionId == sessionId);
                    var isGhost = ps.getTimeLeft() > 0;
                    drawTurret(ps, isYou, isGhost);
                }
            }
        }
        // Draws turret
        function drawTurret(ps, isYou, isGhost) {
            var turret = ps.turret;
            // Draw base
            ctx.save();
            ctx.translate(getXOffset() + turret.x, getYOffset() + turret.y);
            ctx.fillStyle = turret.color;
            ctx.strokeStyle = "black";
            if (!isYou)
                ctx.globalAlpha = transparency;
            else ctx.globalAlpha = 1;
            ctx.beginPath();
            var endAngle = Math.PI * 2;
            ctx.arc(0, 0, turret.baseRadius * turret.life / 100, 0, endAngle, true);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.restore();
            // Draw inner base
            ctx.save();
            ctx.translate(getXOffset() + turret.x, getYOffset() + turret.y);
            ctx.fillStyle = "white";
            ctx.strokeStyle = "black";
            if (!isYou)
                ctx.globalAlpha = transparency;
            else ctx.globalAlpha = 1;
            ctx.beginPath();
            ctx.arc(0, 0, turret.baseRadius / 2, 0, endAngle, true);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.restore();

            // Draw Gun
            ctx.save();
            var angle1 = turret.angle + Math.PI / 2;
            var x1 = turret.recoilX + 2.5 * Math.cos(angle1);
            var y1 = turret.recoilY + 2.5 * Math.sin(angle1);
            var x2 = x1 + turret.length * Math.cos(turret.angle);
            var y2 = y1 + turret.length * Math.sin(turret.angle);
            var angle3 = turret.angle - Math.PI / 2;
            var x3 = x2 + 5 * Math.cos(angle3);
            var y3 = y2 + 5 * Math.sin(angle3);
            var angle4 = angle3 - Math.PI / 2;
            var x4 = x3 + turret.length * Math.cos(angle4);
            var y4 = y3 + turret.length * Math.sin(angle4);
            var x5 = x4 + 2.5 * Math.cos(angle1);
            var y5 = y4 + 2.5 * Math.sin(angle1);
            ctx.lineWidth = 1;
            ctx.fillStyle = "silver";
            ctx.strokeStyle = "black";
            //if (!isYou) alert("got here");
            ctx.globalAlpha = 0.2;
            ctx.beginPath();
            //if (isYou)
            //alert(x1 + "," + y1 + "," + x2 + "," + y2);
            ctx.moveTo(getXOffset() + turret.recoilX, getYOffset() + turret.recoilY);
            ctx.lineTo(getXOffset() + x1, getYOffset() + y1);
            ctx.lineTo(getXOffset() + x2, getYOffset() + y2);
            ctx.lineTo(getXOffset() + x3, getYOffset() + y3);
            ctx.lineTo(getXOffset() + x4, getYOffset() + y4);
            ctx.lineTo(getXOffset() + x5, getYOffset() + y5);
            ctx.fill();
            ctx.stroke();
            ctx.restore();
            if (turret.recoil > 0) {
                turret.recoil = turret.recoil - 1;
            }
		  //if (!isYou)alert("got here");
            if (isGhost) {
                ctx.save();
                ctx.font = "8pt Courier New";
                ctx.fillStyle = "white";
                ctx.globalAlpha = .5;
                ctx.fillText(ps.getTimeLeft(), getXOffset() + turret.x - 14, getYOffset() + turret.y - 14);
                ctx.restore();
                ctx.save();
                ctx.translate(getXOffset() + turret.x, getYOffset() + turret.y);
                ctx.arc(0, 0, turret.length, 0, 2 * Math.PI, false);
                ctx.fillStyle = turret.color;
                ctx.globalAlpha = 0.1;
                ctx.fill();
                ctx.restore();
            } else {
                ctx.save();
                ctx.font = "8pt Courier New";
                ctx.fillStyle = "white";
                ctx.globalAlpha = .8;
                ctx.fillText(ps.name, getXOffset() + turret.x - 14, getYOffset() + turret.y - 25);
                ctx.fillText("score: " + ps.kills, getXOffset() + turret.x - 14, getYOffset() + turret.y - 17);
                ctx.restore();
            }
        }

        function drawLocation() {
            // Draw location
            var ps = PlayerSession.all[sessionId];
            if (ps != null) {
                ctx.save();
                ctx.font = "8pt Courier New";
                ctx.fillStyle = "yellow";
                var x = PlayerSession.all[sessionId].turret.x;
                var y = PlayerSession.all[sessionId].turret.y;
                ctx.fillText("Location: " + x + "," +
                    y, 10, 25);
                ctx.restore();
            }
        }
        
        function drawNumPlayers() {
            ctx.save();
            ctx.font = "8pt Courier New";
            ctx.fillStyle = "white";
            ctx.fillText("# Players: " + Object.keys(PlayerSession.all).length, 600, 25);
            ctx.restore();
        }

        function drawScore() {
            ctx.save();
            ctx.font = "8pt Courier New";
            ctx.fillStyle = "white";
            ctx.fillText("" + score + " destroyed", 10, 480);
            ctx.restore();
        }

        function drawHelp() {
            ctx.save();
            ctx.font = "8pt Courier New";
            ctx.fillStyle = "greenyellow";
            ctx.fillText("INSTRUCTIONS : \u2190 (a), \u2192 (d), \u2191 (w), \u2193 (s), Shoot (Left Mouse Button)", canvas.width/2/scale - 200, 25);
            ctx.restore();
        }

        function drawGameOver() { 
            //alert("draw game over"); 
            ctx.save();
            ctx.font = "bold 16pt Courier New";
            ctx.fillStyle = "yellow";
            ctx.fillText("Game Over", 40, 40);
            ctx.restore();
        }

        function drawGamePaused() {
            ctx.save();
            ctx.font = "bold 24pt Calibri";
            ctx.fillStyle = "#6495ED";
            ctx.fillText("(P)lay", 200, 100);
            ctx.restore();
        }

        function drawGameStart() {
            ctx.save();
            ctx.font = "bold 24pt Calibri";
            ctx.fillStyle = "#6495ED";
            ctx.fillText("(S)tart", 200, 100);
            ctx.restore();
        }

        function drawScores() {
            ctx.save();
            ctx.font = "8pt Calibri";
            ctx.fillStyle = "#6495ED";
            ctx.fillText("Leader Board : ", canvas.width/scale - 120, 50);
            ctx.restore();
            ctx.save();
            ctx.font = "8pt Calibri";
            ctx.fillStyle = "green";
            var inc = 20;
            //debug("scores " + scores);
            var cnt = 0;
            //var s = sortScores();
            for (var idx in scores) {
                if (cnt++ > 9) break;
                var sc = scores[idx];
                ctx.fillText("" + sc["n"] + " : " + sc["s"], canvas.width/scale - 120, 50 + inc);
                inc += 20;
            }
            ctx.restore();
         }
 
        function moveRocks() {
            for (var rockId in Rock.all) {
                if (Rock.all.hasOwnProperty(rockId)) {
                    var rock = Rock.all[rockId];
                    rock.x += rock.vx;
                    rock.y += rock.vy;
                    //rockCollideTurret(rock);
                    if (rock.x <= 0 || rock.y <= 0 || rock.x % canvas.width !== rock.x ||
                        rock.y % canvas.height !== rock.y) {
                        rock.remove();
                    }
                }
            }
        }

        function moveBullets() {
            for (var i in Bullet.all) {
                if (Bullet.all.hasOwnProperty(i)) {
                    var bullet = Bullet.all[i];
                    bullet.x += bullet.vx;
                    bullet.y += bullet.vy;
                    //bulletCollideRock(bullet);
                    if (bullet.x <= 0 || bullet.y <= 0 ||
                        bullet.x % canvas.width !== bullet.x ||
                        bullet.y % canvas.height !== bullet.y) {
                        bullet.remove();
                    }
                }
            }
        }
        // Bullet to Rock collision
        function bulletCollideRock(bullet) {
            for (var idx in Rock.all) {
                var rock = Rock.all[idx];
                if (distance(rock.x, rock.y, bullet.x, bullet.y) <= (bullet.r + rock.r)) {
                    bullet.remove();
                    if (rock.r < 20) {
                        rock.remove();
                        //score += 1;
                    } else {
                        rock.r = rock.r - 5;
                        rock.resize();
                    }
                    break;
                }
            }
        }
        //Rock to Turret collision
        function rockCollideTurret(rock) {
            if (distance(turret.x, turret.y, rock.x, rock.y) <= (5 + rock.r)) {
                //gameOver = 1;
                //scores = [];
                //socket.emit('submitscore', score);
            }
        }

        function distance(x1, y1, x2, y2) {
            var diffx = x2 - x1;
            var diffy = y2 - y1;
            return Math.sqrt(diffx * diffx + diffy * diffy);
        }

        function debug(info) {
            //alert(info);
            ctx.save();
            ctx.font = "8pt Courier New";
            ctx.fillStyle = "yellow";
            ctx.fillText("Debug: " + info, 10, 50);
            ctx.restore();
        }
        // Constructor
        function Turret(x, y, color) {
            this.x = x;
            this.y = y;
            this.length = 20;
            this.speed = 1;
            this.date = new Date();
            this.fillIdx = 0;
            this.hor = 0;
            this.ver = 0;
            this.color = color;
            this.angle = 0;
            this.baseRadius = 15;
            this.mousePosX = 250;
            this.mousePosY = 250;
            this.recoilX = 0;
            this.recoilY = 0;
            this.life = 100;
        }

        function PlayerSession(sessId, turret, timeLeft) {
            this.sessionId = sessId;
            this.turret = turret;
            this.moved = false;
            this.date = new Date();
            this.timeLeft = timeLeft;
            this.kills = 0;
            this.name = null;
            PlayerSession.all[this.sessionId] = this;
        }
        PlayerSession.all = {};
        PlayerSession.prototype = {
            remove: function() {
                //delete PlayerSession.all[this.sessionId];
                delete PlayerSession.all[this.sessionId];

            },
            getTimeLeft: function() {
                var t = Math.round(((this.date.getTime() + this.timeLeft - new Date().getTime())) / 1000);
                return t;
            }
        };
        // Constructor
        function Bullet(x, y, r, color, sessionId, id) {
            this.px = -1;
            this.py = -1;
            this.x = x;
            this.y = y;
            this.r = r;
            this.vx = 0;
            this.vy = 0;
            this.sessionId = sessionId;
            this.color = color;
            this.id = id;
            Bullet.all[id] = this;
            this.cvs = null;
            this.cvsCtx = null;
        }
        Bullet.all = {};
        Bullet.draw_all = function() {
            for (var i in Bullet.all) {
                if (Bullet.all.hasOwnProperty(i)) {
                    Bullet.all[i].draw();
                }
            }
        };
        Bullet.prototype = {
            draw: function() {
                if (this.cvs == null) {
                    this.cvs = document.createElement("canvas");
                    this.cvs.width = this.r * 2;
                    this.cvs.height = this.r * 2;
                    this.cvsCtx = this.cvs.getContext("2d");
                    this.cvsCtx.save();
                    //cvsCtx.translate(getXOffset() + this.x, getYOffset() + this.y);
                    this.cvsCtx.fillStyle = this.color;
                    this.cvsCtx.strokeStyle = "black";
                    this.cvsCtx.beginPath();
                    this.cvsCtx.arc(this.r, this.r, this.r, 0, Math.PI * 2, true);
                    this.cvsCtx.closePath();
                    this.cvsCtx.fill();
                    this.cvsCtx.stroke();
                    this.cvsCtx.restore();
                }
                ctx.save();
                ctx.translate(getXOffset() + this.x, getYOffset() + this.y);
                ctx.drawImage(this.cvs, -this.r, -this.r);
                ctx.restore();
            },
            remove: function() {
                //alert("bullet " + Bullet.all[this.id]);
                delete Bullet.all[this.id];
            }
        };

        Bullet.deserialize = function(data) {
            var bullet = new Bullet(data["x"], data["y"], data["r"], data["color"], data["sessionId"], data["id"]);
            bullet.vx = data["vx"];
            bullet.vy = data["vy"];
        };

        Bullet.moveBullet = function(data) {
            //debug("bullet : " + data);
            var bullet = Bullet.all[data["id"]];          
            if (bullet == null) {
                socket.emit("gb", {"id": data["id"]});
            } else {
                //debug("bullet : " + bullet);
                bullet.px = bullet.x;
                bullet.py = bullet.y;
                bullet.x = data["x"];
                bullet.y = data["y"];
            }
        };
      
        Bullet.removeDeadBullets = function() {
            for (var i in Bullet.all) {
                if (Bullet.all.hasOwnProperty(i)) {
                    var bullet = Bullet.all[i];
                    if (bullet.x === bullet.px && bullet.y === bullet.py) {
                        //alert("dead bullet " + bullet.id);
                        delete Bullet.all[i];
                    } else if (bullet.x != bullet.px || bullet.y != bullet.py) {
                        bullet.px = bullet.x;
                        bullet.py = bullet.y;
                        //alert("updating px,py");
                    } 
                }
            }  
        };

        function Coord(x, y) {
            this.x = x;
            this.y = y;
        }
        // Constructor
        function Rock(x, y, r, id) {
            this.color = "white";
            this.x = x;
            this.y = y;
            this.r = r;
            this.angle = 0;
            this.vx = 0;
            this.vy = 0;
            this.jaggedNess = 10;
            this.coords = [];
            this.drawangle = 0;
            this.spinDirection = 1;
            this.numEdges = 18;
            this.id = id; 
            this.cvs = null;
            this.cvsCtx = null;
        }
        Rock.all = {};
        Rock.deserialize = function(data) {
            var rock = new Rock(data["x"], data["y"], data["r"], data["id"]);
            rock.color = data["color"];
            rock.angle = data["angle"];
            rock.vx = data["vx"];
            rock.vy = data["vy"];
            rock.jaggedNess = data["jaggedNess"];
            rock.coords = data["coords"];
            rock.drawangle = data["drawangle"];
            rock.spinDirection = data["spinDirection"];
            rock.numEdges = data["numEdges"];
            return rock;
        };
        Rock.draw_all = function() {
            for (var idx in Rock.all) {
                if (Rock.all.hasOwnProperty(idx)) {
                    Rock.all[idx].draw();
                }
            }
        };

        Rock.moveRock = function(data) {
            var rock = Rock.all[data["id"]];
            if (rock == null) {
                //alert("null rock");
                socket.emit("gr", {"id" : data["id"]});
            }
            else {
                rock.x = data["x"];
                rock.y = data["y"];
            }
        };

        Rock.prototype = {
            remove: function() {
                delete Rock.all[this.id];
            },
            draw: function() {
                if (this.cvs == null) {
                    this.cvs = document.createElement("canvas");
                    this.cvs.width = this.r * 2;
                    this.cvs.height = this.r * 2;
                    this.cvsCtx = this.cvs.getContext("2d");
                    this.cvsCtx.save();
                    //this.cvsCtx.rotate(this.drawangle * Math.PI / 180);
                    //this.drawangle = (this.drawangle + (1 * this.spinDirection)) % 360;
                    this.cvsCtx.fillStyle = this.color;
                    this.cvsCtx.strokeStyle = "black";
                    this.cvsCtx.lineWidth = 1;
                    this.cvsCtx.beginPath();
                    var isFirst = 1;
                    for (var idx in this.coords) {
                        var coord = this.coords[idx];
                        if (isFirst == 1) {
                            this.cvsCtx.moveTo(coord[0] + this.r, coord[1] + this.r);
                            isFirst = 0;
                        } else {
                            this.cvsCtx.lineTo(coord[0] + this.r, coord[1] + this.r);
                        }
                    }
                    this.cvsCtx.closePath();
                    this.cvsCtx.fill();
                    this.cvsCtx.stroke();
                    if (this.color == "lightblue") {
                        this.cvsCtx.font = "bold 18pt Courier New";
                        this.cvsCtx.fillStyle = "red";
                        this.cvsCtx.fillText("\u2665", this.r, this.r);
                    }
                    this.cvsCtx.restore();
                }
                ctx.save();
                ctx.translate(getXOffset() + this.x, getYOffset() + this.y);
                ctx.rotate(this.drawangle * Math.PI / 180);
                this.drawangle = (this.drawangle + (1 * this.spinDirection)) % 360;
                ctx.drawImage(this.cvs, -this.r, -this.r);
                ctx.restore();
            }
        };
        // Adding in various event handlers
        canvas.addEventListener('mousemove', function(evt) {
            getMousePos(canvas, evt);
        }, false);
        canvas.addEventListener('mousedown', function(evt) {
            if (gamePaused == 1 || gameOver == 1) return;
            mouseDown = 1;
            if (socket != null)
                socket.emit("mouseDown");
        }, false);
        canvas.addEventListener('mouseup', function(evt) {
            mouseDown = 0;
            if (socket != null)
                socket.emit("mouseUp");
        }, false);
        canvas.onselectstart = function() {
            return false;
        }

        function drawInputName() {
            ctx.save();
            ctx.font = "12pt Courier New";
            ctx.fillStyle = "yellow";
            var x = PlayerSession.all[sessionId].turret.x;
            var y = PlayerSession.all[sessionId].turret.y;
            ctx.fillText("Enter nick name: " + nickName, 10, 20);
            ctx.fillText("Push <Enter> to continue", 10, 40);
            ctx.restore();
        }


        function drawStars() {
            if (starsCanvas == null) return;
            ctx.save();
            if(starsPositions.length > 0) 
                ctx.drawImage(starsCanvas, -getXOffset(), -getYOffset(), canvas.width/scale, canvas.height/scale, 0, 0, canvas.width/scale, canvas.height/scale);
            else 
                ctx.drawImage(starsCanvas, 0, 0, canvas.width/scale, canvas.height/scale, 0, 0, canvas.width/scale, canvas.height/scale);
            ctx.restore();
            //alert("draw stars");
        }

        {
            starsCanvas = document.createElement("canvas");
            starsCanvas.width = MAX_X;
            starsCanvas.height = MAX_Y;
            starsCtx = starsCanvas.getContext("2d");
            starsCtx.save();
            starsCtx.fillStyle = "black";
            starsCtx.fillRect(0, 0, starsCanvas.width, starsCanvas.height);
            starsCtx.restore();
        }

        function drawWorld() {
              requestAnimationFrame(drawWorld);
              removeStuff(); 
              drawStars();
              ctx.save();
              ctx.lineWidth = 2;
              ctx.strokeStyle = "#6495ED";
              ctx.strokeRect(2, 2, canvas.width/scale - 4, canvas.height/scale - 4);
              ctx.restore();
              drawTurrets();
              Bullet.draw_all();
              Rock.draw_all();
              drawScores();
              drawHelp();
              drawLocation();
        }
        drawWorld();
    </script>
</body>

</html>
